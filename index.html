<!DOCTYPE html><html lang="zh-CN">
<head>
  <!-- Firebase å…¼å®¹ç‰ˆ CDNï¼ˆé€‚é…æˆ‘ä»¬ç°æœ‰å†™æ³•ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // âš ï¸ æŠŠä¸‹é¢çš„é…ç½®æ¢æˆä½ åˆšå¤åˆ¶çš„ firebaseConfig
  const firebaseConfig = {
  apiKey: "AIzaSyCNzLZhbA5fzPx6uPWGVtgW5NOExShdSWo",
  authDomain: "love-home-7d8ad.firebaseapp.com",
  projectId: "love-home-7d8ad",
  storageBucket: "love-home-7d8ad.firebasestorage.app",
  messagingSenderId: "390892741751",
  appId: "1:390892741751:web:adf9c6f69dcd3b79101272"
};

  // åˆå§‹åŒ–
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ä¸€ä¸ªå…±äº«æ–‡æ¡£ä½ç‚¹ï¼šæˆ‘ä»¬ä¿©å…±ç”¨åŒä¸€æ¡è®°å½•ï¼ˆä½ å¯ä»¥æ”¹æˆè‡ªå·±çš„IDï¼‰
  const DOC = db.collection("love-home").doc("shared");

  // ç®€å•çš„åˆå¹¶å†™å·¥å…·ï¼šæŠŠæœ¬åœ°çŠ¶æ€å†™å›äº‘ç«¯
  async function mergeDoc(patch){
    await DOC.set(patch, { merge: true });
  }

  // é¦–æ¬¡åˆ›å»ºæ–‡æ¡£ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  DOC.get().then(snap=>{
    if(!snap.exists){
      mergeDoc({
        notes: "",
        todos: [],
        marks: [],
        countdown: null,
        updatedAt: Date.now()
      });
    }
  });

  // å®æ—¶è®¢é˜…ï¼šäº‘ç«¯å˜åŒ–â†’è‡ªåŠ¨æ›´æ–°åˆ°é¡µé¢ï¼ˆè¦†ç›–æœ¬åœ°æ˜¾ç¤ºï¼‰
  DOC.onSnapshot(snap => {
    const data = snap.data();
    if(!data) return;

    // ç•™è¨€æ¿
    if(typeof data.notes === "string"){
      const el = document.getElementById('notes');
      if(el && el !== document.activeElement){ el.value = data.notes; }
    }

    // å¾…åŠ
    if(Array.isArray(data.todos)){
      try { window.todos = data.todos; } catch(e){}
      if(typeof render === "function"){ render(); }
    }

    // æ‰“å¡
    if(Array.isArray(data.marks)){
      try { window.marks = data.marks; } catch(e){}
      if(typeof showMarks === "function"){ showMarks(); }
    }

    // å€’è®¡æ—¶
    if(data.countdown){
      const v = data.countdown; // ISOå­—ç¬¦ä¸²
      const dt = document.getElementById('dt');
      if(dt && !dt.value) dt.value = v.replace('Z',''); // ç®€å•å›æ˜¾
    }
  });
</script>
  <script>
// ========== å…±äº«ç•™è¨€å¢™ï¼šæ•°æ®ç»“æ„ ==========
// æˆ‘ä»¬æ²¿ç”¨å·²æœ‰ DOCï¼ˆlove-home / sharedï¼‰
// åœ¨å…¶ä¸­ä¿å­˜ä¸€ä¸ªå­—æ®µ messages: [{author, text, ts}, ...]

// æ¸²æŸ“å‡½æ•°
function renderWall(list) {
  const box = document.getElementById('wallList');
  if (!box) return;
  if (!Array.isArray(list) || list.length === 0) {
    box.innerHTML = '<div class="muted" style="padding:10px">è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå…ˆæ¥ä¸€å¥å¼€åœºç™½ï¼Ÿ</div>';
    return;
    }
  box.innerHTML = '';
  list
    .slice() // å¤åˆ¶
    .sort((a,b)=> (a.ts||0) - (b.ts||0)) // æ—¶é—´å‡åº
    .forEach((m)=>{
      const row = document.createElement('div');
      row.style.padding = '10px';
      row.style.borderBottom = '1px dashed #f1e7f7';
      const when = m.ts ? new Date(m.ts).toLocaleString() : '';
      const who  = m.author || 'ä½šå';
      const text = (m.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      row.innerHTML = `
        <div style="font-size:13px" class="muted">${when} Â· ${who}</div>
        <div style="margin-top:4px">${text}</div>
      `;
      box.appendChild(row);
    });
}

// å‘é€ä¸€æ¡
async function pushWall() {
  const inp = document.getElementById('wallInput');
  if (!inp) return;
  const v = (inp.value || '').trim();
  if (!v) return;

  // è¯»å–å½“å‰ messagesï¼Œè¿½åŠ ä¸€æ¡å†å†™å›ï¼ˆåŸå­åˆå¹¶ï¼‰
  const snap = await DOC.get();
  const data = snap.exists ? snap.data() : {};
  const msgs = Array.isArray(data.messages) ? data.messages.slice() : [];

  msgs.push({
    author: 'é±¼å®',        // ä½ ä¹Ÿå¯ä»¥æ”¹æˆ prompt æˆ–ä½ çš„æ˜µç§°
    text: v,
    ts: Date.now()
  });

  await DOC.set({ messages: msgs, updatedAt: Date.now() }, { merge: true });
  try { localStorage.setItem('messages', JSON.stringify(msgs)); } catch(e){}
  inp.value = '';
  renderWall(msgs);
}

// æŠŠäº‘ç«¯å˜åŒ–å®æ—¶å›å¡«åˆ°ç•™è¨€å¢™
// åœ¨ä½ ç°æœ‰çš„ DOC.onSnapshot(...) é‡Œï¼Œè¿½åŠ ä»¥ä¸‹ç‰‡æ®µï¼š
// ï¼ˆå¦‚æœä½ å·²å†™è¿‡ onSnapshotï¼Œå°±æŠŠè¿™æ®µæ”¾è¿›å›è°ƒé‡Œï¼‰
if (typeof DOC !== 'undefined') {
  DOC.onSnapshot(snap=>{
    const d = snap.data() || {};
    if (Array.isArray(d.messages)) {
      try { localStorage.setItem('messages', JSON.stringify(d.messages)); } catch(e){}
      renderWall(d.messages);
    }
  });
}

// é¡µé¢åˆæ¬¡åŠ è½½æ—¶ï¼Œç”¨æœ¬åœ°ç¼“å­˜å…ˆæ¸²æŸ“ä¸€éï¼Œé¿å…ç™½å±
document.addEventListener('DOMContentLoaded', ()=>{
  try {
    const cached = JSON.parse(localStorage.getItem('messages') || '[]');
    renderWall(cached);
  } catch(e){ renderWall([]); }
});
</script>
  <script>
// ========== å¥–æƒ©å°è´¦çš„æ•°æ®ç»“æ„ï¼ˆå­˜è¿› DOCï¼šlove-home/sharedï¼‰ ==========
// ledger = { history: [{type:'reward'|'punish', title, note, ts}], totalKiss: number, totalPunish: number }

function ensureLedgerShape(d){
  if(!d.ledger) d.ledger = { history: [], totalKiss: 0, totalPunish: 0 };
  d.ledger.history ||= [];
  d.ledger.totalKiss  = Number(d.ledger.totalKiss||0);
  d.ledger.totalPunish= Number(d.ledger.totalPunish||0);
  return d;
}

// æ¸²æŸ“
function renderLedger(ledger){
  ledger = ensureLedgerShape({ledger}).ledger;
  const list = document.getElementById('ledgerList');
  const tk   = document.getElementById('totalKiss');
  const tp   = document.getElementById('totalPunish');
  if(tk) tk.textContent = ledger.totalKiss;
  if(tp) tp.textContent = ledger.totalPunish;

  if(!list) return;
  if(ledger.history.length === 0){
    list.innerHTML = '<div class="muted" style="padding:10px">è¿˜æ²¡æœ‰è®°å½•ï¼Œå¼€å§‹ä¸€æ¬¡ä¸“æ³¨è¯•è¯•ï¼Ÿ</div>';
    return;
  }
  list.innerHTML = '';
  ledger.history
    .slice()
    .sort((a,b)=> (b.ts||0)-(a.ts||0)) // æ–°çš„åœ¨ä¸Š
    .forEach(item=>{
      const row = document.createElement('div');
      row.style.padding = '10px';
      row.style.borderBottom = '1px dashed #f1e7f7';
      const when = new Date(item.ts||Date.now()).toLocaleString();
      const tag  = item.type === 'reward' ? 'âœ… å¥–åŠ±' : 'âŒ æƒ©ç½š';
      row.innerHTML = `
        <div class="muted" style="font-size:12px">${when} Â· ${tag}</div>
        <div style="margin-top:4px"><b>${item.title||''}</b> ${item.note? 'â€” '+item.note : ''}</div>
      `;
      list.appendChild(row);
    });
}

// è®°ä¸€æ¡å¥–åŠ±
async function addReward(title, note){
  const snap = await DOC.get(); const d = ensureLedgerShape(snap.exists ? snap.data() : {});
  d.ledger.history.push({ type:'reward', title, note, ts: Date.now() });
  d.ledger.totalKiss += 1;
  await mergeDoc({ ledger: d.ledger, updatedAt: Date.now() });
  try{ localStorage.setItem('ledger', JSON.stringify(d.ledger)); }catch(e){}
  renderLedger(d.ledger);
}

// è®°ä¸€æ¡æƒ©ç½š
async function addPunish(title, note){
  const snap = await DOC.get(); const d = ensureLedgerShape(snap.exists ? snap.data() : {});
  d.ledger.history.push({ type:'punish', title, note, ts: Date.now() });
  d.ledger.totalPunish += 1;
  await mergeDoc({ ledger: d.ledger, updatedAt: Date.now() });
  try{ localStorage.setItem('ledger', JSON.stringify(d.ledger)); }catch(e){}
  renderLedger(d.ledger);
}

// å…‘æ¢ä¸€å¼ äº²äº²åˆ¸ï¼ˆæ€»æ•° -1ï¼Œå¹¶è®°å±¥å†ï¼‰
async function redeemKiss(){
  const snap = await DOC.get(); const d = ensureLedgerShape(snap.exists ? snap.data() : {});
  if(d.ledger.totalKiss <= 0) { alert('è¿˜æ²¡æœ‰äº²äº²åˆ¸å“¦ï½å…ˆå®Œæˆä¸€ä¸ªç•ªèŒ„å†æ¥å…‘æ¢'); return; }
  d.ledger.totalKiss -= 1;
  d.ledger.history.push({ type:'reward', title:'ä½¿ç”¨äº²äº²åˆ¸', note:'å·²å…‘æ¢ä¸€æš ğŸ’‹', ts: Date.now() });
  await mergeDoc({ ledger: d.ledger, updatedAt: Date.now() });
  try{ localStorage.setItem('ledger', JSON.stringify(d.ledger)); }catch(e){}
  renderLedger(d.ledger);
}

// å®Œæˆä¸€é¡¹æƒ©ç½šï¼ˆæ€»æ•° -1ï¼Œå¹¶è®°å±¥å†ï¼‰
async function clearPunish(){
  const snap = await DOC.get(); const d = ensureLedgerShape(snap.exists ? snap.data() : {});
  if(d.ledger.totalPunish <= 0) { alert('ä»Šå¤©æ²¡æœ‰å¾…å®Œæˆçš„æƒ©ç½šï½'); return; }
  d.ledger.totalPunish -= 1;
  d.ledger.history.push({ type:'punish', title:'å®Œæˆæƒ©ç½š', note:'æ‰§è¡Œä¸€é¡¹è‡ªé€‰æƒ©ç½š âœ…', ts: Date.now() });
  await mergeDoc({ ledger: d.ledger, updatedAt: Date.now() });
  try{ localStorage.setItem('ledger', JSON.stringify(d.ledger)); }catch(e){}
  renderLedger(d.ledger);
}

// äº‘ç«¯ â†’ å›å¡«ï¼ˆæŠŠè¿™æ®µåŠ åˆ°ä½ å·²æœ‰ DOC.onSnapshot å›è°ƒé‡Œï¼Œæˆ–ç´§è·Ÿå…¶åï¼‰
DOC.onSnapshot(snap=>{
  const d = snap.data() || {};
  if(d.ledger){
    try{ localStorage.setItem('ledger', JSON.stringify(d.ledger)); }catch(e){}
    renderLedger(d.ledger);
  }
});

// é¡µé¢åˆè½½ï¼šç”¨æœ¬åœ°ç¼“å­˜å…ˆæ¸²æŸ“ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const cached = JSON.parse(localStorage.getItem('ledger')||'{}');
    if(cached) renderLedger(cached);
  }catch(e){ renderLedger({ history:[], totalKiss:0, totalPunish:0 }); }
});
    // è®°å½•ç¦»å¼€æ—¶é—´
let _leaveStart = 0;

document.addEventListener('visibilitychange', ()=>{
  if (document.hidden) {
    _leaveStart = Date.now();
  } else {
    const away = (Date.now() - _leaveStart) / 1000;
    if (away > 10 && typeof focusing !== 'undefined' && focusing) {
      // æ˜¾ç¤ºæƒ©ç½šæç¤º
      document.getElementById('warn').style.display = 'block';
      // â˜… è‡ªåŠ¨æƒ©ç½šï¼ˆäº‘åŒæ­¥ï¼‰
      addPunish('å­¦ä¹ æºœå·', 'ç¦»å¼€é¡µé¢ > 10 ç§’');
    }
  }
});
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é¡¾æ‰¿Ã—é±¼å®ï½œæƒ…ä¾£è‡ªå¾‹å°å®¶</title>
<link rel="manifest" href="manifest.json" />
<style>
  :root{--pink:#ff8fb3;--vio:#a78bfa;--ink:#222;--bg:#fff7fb}
  *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;color:var(--ink);background:var(--bg)}
  header{padding:16px 20px;position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:saturate(180%) blur(6px);z-index:5;border-bottom:1px solid #f2e9f5}
  h1{margin:0;font-size:18px;display:flex;align-items:center;gap:8px}
  .tabbar{position:sticky;top:56px;background:#fff;border-bottom:1px solid #f2e9f5;display:flex}
  .tabbar button{flex:1;padding:12px;border:0;background:#fff;font-weight:600}
  .tabbar button.active{color:#fff;background:var(--vio)}
  main{padding:14px 14px 80px}
  .card{background:#fff;border:1px solid #f2e9f5;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .row{display:flex;gap:8px;align-items:center}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600}
  .btn-pink{background:var(--pink);color:#fff}
  .btn-plain{background:#f6f0fb}
  .muted{opacity:.7}
  .timer{font-variant-numeric:tabular-nums;font-size:42px;text-align:center;margin:8px 0}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#ffe2ec;margin-right:6px}
  .list{list-style:none;padding:0;margin:0}
  .list li{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed #f1e7f7}
  input,textarea,select{width:100%;padding:10px;border:1px solid #eadff4;border-radius:10px;background:#fff}
  .kudo{display:none;text-align:center;font-weight:700;color:#e11d48}
  .warn{display:none;text-align:center;color:#dc2626;font-weight:700}
  .success{display:none;text-align:center;color:#16a34a;font-weight:700}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  footer{position:fixed;inset:auto 0 0 0;background:#fff;border-top:1px solid #f2e9f5;padding:12px;text-align:center}
</style>
</head>
<body>
<header>
  <h1>ğŸºé¡¾æ‰¿ Ã— ğŸŸé±¼å® Â· æƒ…ä¾£è‡ªå¾‹å°å®¶</h1>
</header>
<nav class="tabbar">
  <button class="active" data-tab="home">ğŸ  ä¸»é¡µ</button>
  <button data-tab="study">ğŸ“š è‡ªå¾‹</button>
  <button data-tab="calendar">ğŸ—“ æ‰“å¡</button>
  <button data-tab="countdown">â³ å€’è®¡æ—¶</button>
</nav>
<main>
  <!-- ä¸»é¡µ -->
  <section class="card" data-page="home">
    <p class="pill">ä»Šæ—¥ç­¾ Â· <span id="dayText">æ¬¢è¿å›å®¶ï¼Œå°ç‹ç‹¸</span></p>
    <div class="card">
      <b>ç§å¯†ç•™è¨€æ¿</b>
      <div class="muted" style="font-size:12px">å†™ç»™å½¼æ­¤çš„å°çº¸æ¡ï¼ˆä»…ä¿å­˜åœ¨ä½ æ‰‹æœºï¼‰</div>
      <textarea id="notes" rows="4" placeholder="æƒ³æˆ‘å°±å†™ç‚¹ä»€ä¹ˆï½"></textarea>
      <button id="saveBtn" onclick="saveNotes()">ä¿å­˜</button>
<div id="saveHint" style="color:#999;margin-top:4px;"></div>
      <div style="margin-top:8px" class="row">
       <span id="saveHint" class="muted"></span>
      </div>
    </div>
    <!-- å…±äº«ç•™è¨€å¢™ï¼ˆäº‘åŒæ­¥ï¼‰ -->
<div class="card">
  <b>å…±äº«ç•™è¨€å¢™ï¼ˆæˆ‘ä»¬ä¿©éƒ½èƒ½çœ‹åˆ°ï¼‰</b>
  <div id="wallList" class="list" style="max-height:220px; overflow:auto; margin:8px 0; border:1px dashed #f1e7f7; border-radius:10px;"></div>

  <div class="row" style="margin-top:8px">
    <input id="wallInput" placeholder="å¯¹å½¼æ­¤è¯´ç‚¹ä»€ä¹ˆâ€¦"/>
    <button class="btn btn-pink" onclick="pushWall()">å‘é€</button>
  </div>

  <div class="muted" style="font-size:12px;margin-top:6px">
    æç¤ºï¼šè¿™å—å†…å®¹äº‘ç«¯å…±äº«ï¼Œä»»æ„è®¾å¤‡æ‰“å¼€åŒä¸€ç½‘å€éƒ½ä¼šçœ‹åˆ°
  </div>
</div>
  </section>  <!-- è‡ªå¾‹å­¦ä¹  -->  <section class="card" data-page="study" hidden>
    <b>ä¸“æ³¨è®¡æ—¶ï¼ˆç•ªèŒ„é’Ÿï¼‰</b>
    <div class="grid2" style="margin:8px 0">
      <select id="tomatoLen">
        <option value="25">25 åˆ†é’Ÿ</option>
        <option value="45">45 åˆ†é’Ÿ</option>
        <option value="60">60 åˆ†é’Ÿ</option>
      </select>
      <select id="breakLen">
        <option value="5">ä¼‘æ¯ 5 åˆ†é’Ÿ</option>
        <option value="10">ä¼‘æ¯ 10 åˆ†é’Ÿ</option>
      </select>
    </div>
    <div class="timer" id="timer">25:00</div>
    <div class="row">
      <button class="btn btn-pink" onclick="startFocus()">å¼€å§‹å­¦ä¹ </button>
      <button class="btn btn-plain" onclick="resetFocus()">é‡ç½®</button>
    </div>
    <div id="kudo" class="kudo">âœ… ä¹–ï¼æ‰¿å“¥å¥–åŠ±ï¼šäº²äº²åˆ¸Ã—1 ğŸ’‹</div>
    <div id="warn" class="warn">âŒ è¢«å‘ç°æºœå·å•¦ï¼å›æ¥ç»§ç»­ï¼Œå®Œæˆæ‰æœ‰å¥–åŠ±ï¼</div><div class="card">
  <b>å¾…åŠæ¸…å•</b>
  <div class="row" style="margin:6px 0">
    <input id="todoInput" placeholder="å†™ä¸‹ä»Šå¤©è¦åšçš„äº‹â€¦"/>
    <button class="btn btn-pink" onclick="addTodo()">æ·»åŠ </button>
  </div>
  <ul id="todoList" class="list"></ul>
</div>
<!-- å¥–åŠ± / æƒ©ç½šæ¸…å•ï¼ˆäº‘åŒæ­¥ï¼‰ -->
<div class="card">
  <b>å¥–åŠ± / æƒ©ç½šæ¸…å•</b>
  <div class="muted" style="font-size:12px">ç•ªèŒ„å®Œæˆè‡ªåŠ¨è®°â€œäº²äº²åˆ¸Ã—1â€ï¼›å­¦ä¹ ä¸­æºœå·è®°â€œæƒ©ç½šÃ—1â€</div>

  <div id="ledgerTotals" class="row" style="margin:8px 0">
    <span class="pill">äº²äº²åˆ¸ï¼š<b id="totalKiss">0</b></span>
    <span class="pill">æƒ©ç½šï¼š<b id="totalPunish">0</b></span>
  </div>

  <div id="ledgerList" class="list" style="max-height:220px; overflow:auto; border:1px dashed #f1e7f7; border-radius:10px"></div>

  <div class="row" style="margin-top:8px">
    <button class="btn btn-pink" onclick="redeemKiss()">å…‘æ¢ä¸€å¼ äº²äº²åˆ¸ ğŸ’‹</button>
    <button class="btn btn-plain" onclick="clearPunish()">å®Œæˆä¸€é¡¹æƒ©ç½š âœ…</button>
  </div>
    </div>
  </section>  <!-- æ—¥å†æ‰“å¡ï¼ˆç®€ç‰ˆï¼‰ -->  <section class="card" data-page="calendar" hidden>
    <b>é€‰æ‹©æ—¥æœŸå¹¶æ‰“å¡</b>
    <div class="row" style="margin:8px 0">
      <input type="date" id="datePick" />
      <button class="btn btn-pink" onclick="markDay()">æ‰“å¡</button>
    </div>
    <div id="days" class="muted">å°šæ— æ‰“å¡</div>
  </section>  <!-- å€’è®¡æ—¶ -->  <section class="card" data-page="countdown" hidden>
    <b>å€’è®¡æ—¶æé†’</b>
    <div class="row" style="margin:8px 0">
      <input type="datetime-local" id="dt" />
      <button class="btn btn-pink" onclick="setTarget()">å¼€å§‹å€’è®¡æ—¶</button>
    </div>
    <div class="timer" id="left">è®¾ç½®ä¸€ä¸ªæ—¶é—´å§</div>
    <div id="done" class="success">ğŸ‰ æ—¶é—´åˆ°ï¼æ‹¥æŠ±å¥–åŠ±ç”Ÿæ•ˆï¼</div>
  </section>
</main>
<footer>
  <small class="muted">æœ¬åœ°éšç§å­˜å‚¨ Â· ç¦»çº¿å¯ç”¨ Â· åªç»™é±¼å®çœ‹çš„å°å®¶</small>
</footer><script>
  // â€”â€” å¯¼èˆª â€”â€”
  const tabs=[...document.querySelectorAll('.tabbar button')];
  const pages={};
  document.querySelectorAll('[data-page]').forEach(sec=>pages[sec.dataset.page]=sec);
  tabs.forEach(btn=>btn.onclick=()=>{tabs.forEach(b=>b.classList.remove('active'));btn.classList.add('active');Object.values(pages).forEach(s=>s.hidden=true);pages[btn.dataset.tab].hidden=false;localStorage.setItem('tab',btn.dataset.tab)});
  const last=localStorage.getItem('tab');if(last&&pages[last]){tabs.forEach(b=>b.classList.toggle('active',b.dataset.tab===last));Object.values(pages).forEach(s=>s.hidden=true);pages[last].hidden=false}

  // â€”â€” æ¯æ—¥ç­¾ â€”â€”
  const dayLines=["æ¬¢è¿å›å®¶ï¼Œå°ç‹ç‹¸ã€‚","è®°å¾—å–æ°´ï¼Œæˆ‘çš„ã€‚","ä»Šå¤©ä¹Ÿè¦è¢«æˆ‘äº²åˆ°è½¯ã€‚","æ”¾è½»æ¾ï¼Œæˆ‘åœ¨ã€‚","ä½ æŠ¬å¤´æ—¶åƒä¼šå‘å…‰ã€‚"];
  document.getElementById('dayText').textContent=dayLines[new Date().getDay()%dayLines.length];

  // â€”â€” ç•™è¨€æ¿ï¼ˆæœ¬åœ°æŒä¹…åŒ–ï¼‰ â€”â€”
  const notesEl=document.getElementById('notes');
  notesEl.value=localStorage.getItem('notes')||'';
  function saveNotes(){localStorage.setItem('notes',notesEl.value);mergeDoc({ notes: notesEl.value, updatedAt: Date.now() }); const hint=document.getElementById('saveHint');hint.textContent='å·²ä¿å­˜';setTimeout(()=>hint.textContent='',1200)}

  // â€”â€” ç•ªèŒ„é’Ÿ + ç›‘æ§ â€”â€”
  let t=0, total=25*60, ticking=null, focusing=false, hiddenAt=0;
  const timerEl=document.getElementById('timer'),kudo=document.getElementById('kudo'),warn=document.getElementById('warn');
  function fmt(s){const m=Math.floor(s/60).toString().padStart(2,'0');const ss=(s%60).toString().padStart(2,'0');return `${m}:${ss}`}
  function startFocus(){if(focusing) return;const work=parseInt(document.getElementById('tomatoLen').value,10);total=work*60;t=total;focusing=true;kudo.style.display='none';warn.style.display='none';tick()}
  function tick(){ticking=setInterval(()=>{t--;timerEl.textContent=fmt(t);if(t<=0){clearInterval(ticking);focusing=false;kudo.style.display='block';navigator.vibrate&&navigator.vibrate([60,40,60])}},1000)}
  function resetFocus(){clearInterval(ticking);focusing=false;t=parseInt(document.getElementById('tomatoLen').value,10)*60;timerEl.textContent=fmt(t);kudo.style.display='none';warn.style.display='none'}
  timerEl.textContent=fmt(total);
  document.addEventListener('visibilitychange',()=>{if(document.hidden){hiddenAt=Date.now()}else if(focusing){const away=(Date.now()-hiddenAt)/1000;if(away>10){warn.style.display='block'}}});

  // â€”â€” å¾…åŠ â€”â€”
  const listEl=document.getElementById('todoList');
  let todos=JSON.parse(localStorage.getItem('todos')||'[]');
  function render(){listEl.innerHTML='';todos.forEach((it,idx)=>{const li=document.createElement('li');li.innerHTML=`<span ${it.done?'class="muted"':''}>${it.text}</span>`;const btn=document.createElement('button');btn.className='btn btn-plain';btn.textContent=it.done?'æ’¤å›':'å®Œæˆ';btn.onclick=()=>{todos[idx].done=!todos[idx].done;saveTodos()};li.appendChild(btn);listEl.appendChild(li)})}
  function saveTodos(){localStorage.setItem('todos',JSON.stringify(todos));mergeDoc({ todos, updatedAt: Date.now() });render()}
  function addTodo(){const inp=document.getElementById('todoInput');const v=inp.value.trim();if(!v) return;todos.push({text:v,done:false});inp.value='';saveTodos()}
  render();

  // â€”â€” æ—¥å†æ‰“å¡ï¼ˆå­˜æ—¥æœŸï¼‰ â€”â€”
  const daysEl=document.getElementById('days');
  let marks=JSON.parse(localStorage.getItem('marks')||'[]');
  function markDay(){const val=document.getElementById('datePick').value;if(!val) return; if(!marks.includes(val)) marks.push(val); localStorage.setItem('marks',JSON.stringify(marks));mergeDoc({ marks, updatedAt: Date.now() });showMarks()}
  function showMarks(){daysEl.textContent = marks.length? 'å·²æ‰“å¡ï¼š'+marks.join('ã€') : 'å°šæ— æ‰“å¡'}
  showMarks();

  // â€”â€” å€’è®¡æ—¶ â€”â€”
  let target=null,downTimer=null;const leftEl=document.getElementById('left'),doneEl=document.getElementById('done');
  function setTarget(){const v=document.getElementById('dt').value;if(!v) return;target=new Date(v);mergeDoc({ countdown: new Date(v).toISOString(), updatedAt: Date.now() }); doneEl.style.display='none';downTimer&&clearInterval(downTimer);downTimer=setInterval(()=>{const diff=target-new Date();if(diff<=0){leftEl.textContent='00:00:00';doneEl.style.display='block';navigator.vibrate&&navigator.vibrate([90,90,120]);clearInterval(downTimer)}else{const s=Math.floor(diff/1000);const h=Math.floor(s/3600).toString().padStart(2,'0');const m=Math.floor(s%3600/60).toString().padStart(2,'0');const ss=(s%60).toString().padStart(2,'0');leftEl.textContent=`${h}:${m}:${ss}`}},1000)}
</script></body>

</html>




